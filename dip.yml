version: "8.0"

environment:
  RAILS_ENV: development

compose:
  files:
    - docker-compose.yml
  project_name: lexiforge

interaction:
  rails:
    description: Run Rails commands
    service: api
    command: rails

  rake:
    description: Run Rake commands
    service: api
    command: rake

  bundle:
    description: Run Bundle commands
    service: api
    command: bundle
    compose:
      run_options: [no-deps]

  rspec:
    description: Run RSpec tests
    service: api
    command: bundle exec rspec
    compose:
      run_options: [no-deps]
    environment:
      RAILS_ENV: test

  rspec-doc:
    description: Run RSpec tests with documentation format
    service: api
    command: bundle exec rspec --format documentation
    compose:
      run_options: [no-deps]
    environment:
      RAILS_ENV: test

  test-setup:
    description: Setup test database
    service: api
    command: sh -c "rails db:create db:migrate RAILS_ENV=test"
    environment:
      RAILS_ENV: test

  rails-test:
    description: Run Rails tests
    service: api
    command: rails test
    compose:
      run_options: [no-deps]

  rubocop:
    description: Run RuboCop
    service: api
    command: bundle exec rubocop
    compose:
      run_options: [no-deps]

  console:
    description: Rails console
    service: api
    command: rails console

  # Database commands
  psql:
    description: Connect to PostgreSQL database
    service: db
    command: psql -U lexiforge -d lexiforge_development

  createdb:
    description: Create database
    service: api
    command: rails db:create
    compose:
      run_options: [no-deps]

  migrate:
    description: Run migrations
    service: api
    command: rails db:migrate

  seed:
    description: Seed database
    service: api
    command: rails db:seed

  reset:
    description: Reset database
    service: api
    command: rails db:reset

  # Frontend commands
  npm:
    description: Run NPM commands for frontend
    service: frontend
    command: npm
    compose:
      run_options: [no-deps]

  # Development shortcuts
  server:
    description: Start Rails server
    service: api
    command: rails server -b 0.0.0.0
    compose:
      run_options: [service-ports, use-aliases]

  # Utility commands
  bash:
    description: Open bash in API container
    service: api
    command: /bin/bash
    compose:
      run_options: [no-deps]

  sh:
    description: Open shell in API container
    service: api
    command: /bin/sh
    compose:
      run_options: [no-deps]

provision:
  - dip compose down --volumes
  - dip compose up -d db
  - sleep 10
  - dip bundle install
  - dip rails db:create db:migrate db:seed
  - dip npm install
